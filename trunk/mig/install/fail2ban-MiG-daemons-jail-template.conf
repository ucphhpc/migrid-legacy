# Local jail rules
#
# See jail.conf(5) man page for more information


# The DEFAULT allows a global definition of the options. They can be overridden
# in each jail afterwards.

[DEFAULT]

#
# MISCELLANEOUS OPTIONS
#

# "ignoreip" can be an IP address, a CIDR mask or a DNS host. Fail2ban will not
# ban a host which matches an address in this list. Several addresses can be
# defined using space (and/or comma) separator.
ignoreip = 127.0.0.1/8 

# Some options used for actions

# Destination email address used solely for the interpolations in
# jail.{conf,local,d/*} configuration files.
destemail = root@__BASE_FQDN__

# Sender email address used solely for some actions
sender = root@__BASE_FQDN__


#
# JAILS
#

#
# SSH servers
#

# Default sshd jail is called ssh on Debian and sshd on RHEL/CentOS
__NOT_DEB_COMMENTED__[ssh]
__IS_DEB_COMMENTED__[sshd]
enabled = __ENABLE_SFTP_SUBSYS__
port = ssh
filter = sshd
# Excess public keys should never result in ban
ignoreregex = Failed publickey for .* from .* port [0-9]+ ssh2: (RSA|DSA|ECDSA|ED25519) SHA256:.*$
action = iptables-ipset-proto6[name=SSH, bantime=900, port=ssh, protocol=tcp]
# "bantime" is the number of seconds that a host is banned.
bantime = 900
# A host is banned if it has generated "maxretry" during the last "findtime"
# seconds.
findtime = 300
# "maxretry" is the number of failures before a host get banned.
maxretry = 5

## Password cracking target for immediate ban of obvious password crackers
[sshd-pw-crack]
enabled = __ENABLE_SFTP_SUBSYS__
# Debian uses setup with auto backend and logpath defined in jail while
# CentOS/RHEL defines general helpers we can just reuse. 
__NOT_DEB_COMMENTED__logpath = /var/log/auth.log
__NOT_DEB_COMMENTED__backend = auto
__IS_DEB_COMMENTED__logpath = %(sshd_log)s
__IS_DEB_COMMENTED__backend = %(sshd_backend)s
port = ssh
filter = sshd-pw-crack
# Excess public keys should never result in ban
ignoreregex = Failed publickey for .* from .* port [0-9]+ ssh2: (RSA|DSA|ECDSA|ED25519) SHA256:.*$
action = iptables-ipset-proto6[name=SSH-ABUSE, bantime=2592000, port=ssh, protocol=tcp]
# "bantime" is the number of seconds that a host is banned.
bantime = 2592000
findtime = 300
maxretry = 0

# Special abuse target for automatic ban of other obvious abuse and for manual daily
# ban of known offenders
[sshd-abuse]
enabled = __ENABLE_SFTP_SUBSYS__
# Debian uses setup with auto backend and logpath defined in jail while
# CentOS/RHEL defines general helpers we can just reuse. 
__NOT_DEB_COMMENTED__logpath = /var/log/auth.log
__NOT_DEB_COMMENTED__backend = auto
__IS_DEB_COMMENTED__logpath = %(sshd_log)s
__IS_DEB_COMMENTED__backend = %(sshd_backend)s
port = ssh
# RHEL/CentOS has aggressive filter with various additional scan patterns
__IS_DEB_COMMENTED__filter = sshd-aggressive
__NOT_DEB_COMMENTED__filter = sshd
# Excess public keys should never result in ban
ignoreregex = Failed publickey for .* from .* port [0-9]+ ssh2: (RSA|DSA|ECDSA|ED25519) SHA256:.*$
action = iptables-ipset-proto6[name=SSH-ABUSE, bantime=86400, port=ssh, protocol=tcp]
# "bantime" is the number of seconds that a host is banned.
bantime = 86400
findtime = 3600
maxretry = 15

#
# MiG native IO services
#

# SFTP login failures
[migrid-sftp]
enabled = __ENABLE_SFTP__
logpath = __MIG_STATE__/log/sftp.log
# Use pyinotify or polling rather than systemd log
backend = auto
port = 2222
filter = MiG-daemons
# NOTE: target all common forwarded and real IO service ports 
action = iptables-ipset-proto6[name=MiG-DAEMONS, bantime=600, port="21,22,443,2222,4443,8001,8020,8021,8022,8443", protocol=tcp]
# "bantime" is the number of seconds that a host is banned.
bantime = 600
# A host is banned if it has generated "maxretry" during the last "findtime"
# seconds.
findtime = 120
# "maxretry" is the number of failures before a host get banned.
maxretry = 8

## SFTP password cracking target for immediate ban of obvious attackers
[migrid-sftp-pw-crack]
enabled = __ENABLE_SFTP__
logpath = __MIG_STATE__/log/sftp.log
# Use pyinotify or polling rather than systemd log
backend = auto
port = 2222
filter = MiG-daemons-pw-crack
# NOTE: target all common forwarded and real IO service ports 
action = iptables-ipset-proto6[name=MiG-DAEMONS, bantime=864000, port="21,22,443,2222,4443,8001,8020,8021,8022,8443", protocol=tcp]
# "bantime" is the number of seconds that a host is banned.
bantime = 864000
findtime = 100
maxretry = 0


# FTPS login failures
[migrid-ftps]
enabled = __ENABLE_FTPS__
logpath = __MIG_STATE__/log/ftps.log
# Use pyinotify or polling rather than systemd log
backend = auto
port = 8021
filter = MiG-daemons
# NOTE: target all common forwarded and real IO service ports
action = iptables-ipset-proto6[name=MiG-DAEMONS, bantime=600, port="21,22,443,2222,4443,8001,8020,8021,8022,8443", protocol=tcp]
# "bantime" is the number of seconds that a host is banned.
bantime = 600
# A host is banned if it has generated "maxretry" during the last "findtime"
# seconds.
findtime = 120
# "maxretry" is the number of failures before a host get banned.
maxretry = 8

# WebDAVS login failures
[migrid-webdavs]
enabled = __ENABLE_DAVS__
logpath = __MIG_STATE__/log/davs.log
# Use pyinotify or polling rather than systemd log
backend = auto
port = 4443
filter = MiG-daemons
# NOTE: target all common forwarded and real IO service ports
action = iptables-ipset-proto6[name=MiG-DAEMONS, bantime=600, port="21,22,443,2222,4443,8001,8020,8021,8022,8443", protocol=tcp]
# "bantime" is the number of seconds that a host is banned.
bantime = 600
# A host is banned if it has generated "maxretry" during the last "findtime"
# seconds.
findtime = 120
# "maxretry" is the number of failures before a host get banned.
# NOTE: windows client auto retry many times per login so leave it high
maxretry = 16

# OpenID login failures
[migrid-openid]
enabled = __ENABLE_OPENID__
logpath = __MIG_STATE__/log/openid.log
# Use pyinotify or polling rather than systemd log
backend = auto
port = 8443
filter = MiG-daemons
# NOTE: target all common forwarded and real IO service ports
action = iptables-ipset-proto6[name=MiG-DAEMONS, bantime=600, port="21,22,443,2222,4443,8001,8020,8021,8022,8443", protocol=tcp]
# "bantime" is the number of seconds that a host is banned.
bantime = 600
# A host is banned if it has generated "maxretry" during the last "findtime"
# seconds.
findtime = 120
# "maxretry" is the number of failures before a host get banned.
maxretry = 8
