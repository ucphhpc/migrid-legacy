# This is the MiG specific apache configuration.
# It overrides some settings from the main configuration to be able to simply
# include this configuration from any 'vanilla' httpd.conf.
# Only tested with debian + apache 2.2+ but should work with others.

# Server name - comment out to just use hostname
ServerName __BASE_FQDN__

# Point users in the right direction on errors
ServerAdmin __USER__

# We may need to run as MiG user or group for file access to work
# through CGI scripts and for direct user file access
__USER_CLAUSE__ __USER__
__GROUP_CLAUSE__ __GROUP__

# Performance Tuning
StartServers 5
# These two were renamed in apache 2.4
<IfVersion >= 2.4>
    MaxRequestWorkers 250
    MaxConnectionsPerChild 10000
</IfVersion>
<IfVersion < 2.4>
    MaxClients 250
    MaxRequestsPerChild 10000
</IfVersion>

# Do not allow TRACE requests, as recommended by OpenVAS scan results
TraceEnable off

# Default target for all directories not explicitly configured
<Directory "/">
    # Disable all overrides
    AllowOverride None
    # Enable SymLinksIfOwnerMatch and nothing else for all sub dirs
    Options SymLinksIfOwnerMatch
    # Deny all access to base mig dir and only allow on a subdir basis
    <IfVersion >= 2.4>
        Require all denied 
    </IfVersion>
    <IfVersion < 2.4>
        Order deny,allow
        Deny from all
    </IfVersion>
</Directory>
# Public images shared by http and https pages and scripts
Alias /images/ "__MIG_CODE__/images/"
<Directory "__MIG_CODE__/images">
    AuthType none
    <IfVersion >= 2.4>
        Require all granted 
    </IfVersion>
    <IfVersion < 2.4>
        Order allow,deny
        Allow from all
    </IfVersion>
</Directory>
# Other public data shared by http and https pages and scripts
Alias /public/ "__MIG_STATE__/wwwpublic/"
<Directory "__MIG_STATE__/wwwpublic">
    AuthType none
    <IfVersion >= 2.4>
        Require all granted 
    </IfVersion>
    <IfVersion < 2.4>
        Order allow,deny
        Allow from all
    </IfVersion>
</Directory>

# Prevent access to repository dot files to avoid semi-public information leak
<DirectoryMatch "^(__MIG_STATE__|__MIG_CODE__)/(.+/)?\.(cvs|svn|git|hg)">
    <IfVersion >= 2.4>
        Require all denied 
    </IfVersion>
    <IfVersion < 2.4>
        Order deny,allow
        Deny from all
    </IfVersion>
</DirectoryMatch>

# Support relocatable configuration if possible
<IfModule mod_env.c>
    SetEnv MIG_CONF __MIG_CODE__/server/MiGserver.conf
</IfModule>

# Configure WSGI if available
<IfModule mod_wsgi.c>
    # Run WSGI in daemon mode with multiprocessing-only for isolation.
    # Additional information in 'The mod_wsgi Daemon Processes' on:
    # http://code.google.com/p/modwsgi/wiki/ProcessesAndThreading
    #
    # We preserve the default WSGIApplicationGroup setting of '%{RESOURCE}'
    # to force every single application into a dedicated sub-interpreter
    # for complete isolation. This includes different VGrid Trac instances.
    # Please note that the processes number here is a FIXED cap on available 
    # worker processes so it strictly limits the number of concurrent clients.
    WSGIDaemonProcess __BASE_FQDN__ processes=__WSGI_PROCS__ threads=1 display-name=%{GROUP} user=__USER__ group=__GROUP__ python-path=__MIG_CODE__  maximum-requests=1000
    WSGIProcessGroup __BASE_FQDN__
    # Make sure wsgi sockets are fully accessible to __USER__
    # NOTE: make sure SELinux or similar isn't interfering if apache still
    # gets permission errors on startup
    WSGISocketPrefix __MIG_CODE__/wsgi-bin/wsgi
</IfModule>

# Configure PUT script
<IfModule mod_actions.c>
    #
    # Action lets you define media types that will execute a script
    # whenever a matching file is called. This eliminates the need for
    # repeated URL pathnames for oft-used CGI file processors.
    # Format: Action media/type /cgi-script/location
    # Format: Action handler-name /cgi-script/location
    #
    # We need to let implicit put hit SID to allow resources and oneclick
    # Browser upload uses POST and migscripts use explict CERTPUT
    Script PUT /cgi-sid/put
    Script SIDPUT /cgi-sid/put
    Script CERTPUT /cgi-bin/put
</IfModule>

# Configure SSL
# The whole SSL configuration in this context applies both to
# the main server and all SSL-enabled virtual hosts.
<IfModule mod_ssl.c>
    # These should only be explicitly set if not already set
    # elsewhere. This is the case with custom ports or with old
    # apache 1.3.x on Debian, so listen_prefix should be set to '#'
    # with apache 2.x when ports are already configured elsewhere.
    __LISTEN_CLAUSE__ __PUBLIC_PORT__
    <IfDefine MIG_CERT_FQDN>
    __LISTEN_CLAUSE__ __MIG_CERT_PORT__
    </IfDefine>
    <IfDefine EXT_CERT_FQDN>
    __LISTEN_CLAUSE__ __EXT_CERT_PORT__
    </IfDefine>
    <IfDefine MIG_OID_FQDN>
    __IF_SEPARATE_PORTS____LISTEN_CLAUSE__ __MIG_OID_PORT__
    </IfDefine>
    <IfDefine EXT_OID_FQDN>
    __IF_SEPARATE_PORTS____LISTEN_CLAUSE__ __EXT_OID_PORT__
    </IfDefine>
    __IF_SEPARATE_PORTS____LISTEN_CLAUSE__ __SID_PORT__

    # Apache 2.4 changed SSL DN format - Force legacy format that we rely on
    <IfVersion >= 2.4>
        SSLOptions +LegacyDNStringFormat
    </IfVersion>

    # Some MIME-types for downloading Certificates and CRLs
    AddType application/x-x509-ca-cert .crt
    AddType application/x-pkcs7-crl .crl

    # Semaphore:
    #   Configure the path to the mutual exclusion semaphore the
    #   SSL engine uses internally for inter-process synchronization.
    # Changed from SSLMutex to just Mutex in apache>=2.4
    <IfVersion >= 2.4>
        Mutex sem
    </IfVersion>
    <IfVersion < 2.4>
        SSLMutex sem
    </IfVersion>

    # Inter-Process Session Cache:
    #   Configure the SSL Session Cache: First either `none'
    #   or `dbm:/path/to/file' for the mechanism to use and
    #   second the expiring timeout (in seconds).
    # Changed from shm to shmcb in apache 2.4
    <IfVersion >= 2.4>
        SSLSessionCache shmcb:__APACHE_RUN__/mod_ssl_scache
    </IfVersion>
    <IfVersion < 2.4>
        SSLSessionCache shm:__APACHE_RUN__/mod_ssl_scache
    </IfVersion>
    
    SSLSessionCacheTimeout 300

    # Pseudo Random Number Generator (PRNG):
    #   Configure one or more sources to seed the PRNG of the 
    #   SSL library. The seed data should be of good random quality.
    SSLRandomSeed startup file:/dev/urandom 1024
    SSLRandomSeed connect file:/dev/urandom 1024

    #   SSL Cipher Suite:
    #   List the ciphers that the client is permitted to negotiate.
    #   See the mod_ssl documentation for a complete list.
    SSLHonorCipherOrder On
    # Use cipher order recommended by Mozilla for 'Intermediate compatibility'
    # which supports all platforms back to Firefox 1, Chrome 1, IE 7, Opera 5,
    # Safari 1, Windows XP IE8, Android 2.3, Java 7.
    # Please refer to the Mozilla page for background and details about the
    # cipher priority. 
    # https://wiki.mozilla.org/Security/Server_Side_TLS#Apache
    # In short it makes sure TLSv1.2 and secure but light-weight elliptic curve
    # ciphers are preferred and then gracefully falls back to only other secure
    # ciphers.
    # On older versions of OpenSSL, unavailable ciphers will be discarded 
    # automatically.
    # IMPORTANT: try to keep in sync with ciphers elsewhere.
    #            Namely in grid_webdavs.py and SSLProxyCipherSuite below
    SSLCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!DES-CBC3-SHA
    SSLProxyCipherSuite ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!DES-CBC3-SHA

    #   Server Certificate:
    #   Point SSLCertificateFile at a PEM encoded certificate.  If
    #   the certificate is encrypted, then you will be prompted for a
    #   pass phrase.  Note that a kill -HUP will prompt again. A test
    #   certificate can be generated with `make certificate' under
    #   built time. Keep in mind that if you've both a RSA and a DSA
    #   certificate you can configure both in parallel (to also allow
    #   the use of DSA ciphers, etc.)
    SSLCertificateFile __MIG_CERTS__/server.crt

    #   Server Private Key:
    #   If the key is not combined with the certificate, use this
    #   directive to point at the key file.  Keep in mind that if
    #   you've both a RSA and a DSA private key you can configure
    #   both in parallel (to also allow the use of DSA ciphers, etc.)
    SSLCertificateKeyFile __MIG_CERTS__/server.key

    #   Certificate Authority (CA):
    #   Set the CA certificate verification path where to find CA
    #   certificates for client authentication or alternatively one
    #   huge file containing all of them (file must be PEM encoded)
    #   Note: Inside SSLCACertificatePath you need hash symlinks
    #         to point to the certificate files. Use the provided
    #         Makefile to update the hash symlinks after changes.
    SSLCACertificateFile __MIG_CERTS__/cacert.pem

    #   Certificate Revocation Lists (CRL):
    #   Set the CA revocation path where to find CA CRLs for client
    #   authentication or alternatively one huge file containing all
    #   of them (file must be PEM encoded)
    #   Note: Inside SSLCARevocationPath you need hash symlinks
    #         to point to the certificate files. Use the provided
    #         Makefile to update the hash symlinks after changes.
    SSLCARevocationFile __MIG_CERTS__/crl.pem

    # Apache 2.4 defaults to not check CRL at all
    <IfVersion >= 2.4>
        SSLCARevocationCheck chain
    </IfVersion>

    #   SSL Protocol Adjustments:
    #   The safe and default but still SSL/TLS standard compliant shutdown
    #   approach is that mod_ssl sends the close notify alert but doesn't
    #   wait for the close notify alert from client. When you need a
    #   different shutdown approach you can use one of the following
    #   variables:
    #   o ssl-unclean-shutdown:
    #     This forces an unclean shutdown when the connection is closed, 
    #     i.e. no SSL close notify alert is send or allowed to received.
    #     This violates the SSL/TLS standard but is needed for some 
    #     brain-dead browsers. Use this when you receive I/O errors because
    #     of the standard approach where mod_ssl sends the close notify
    #     alert.
    #   o ssl-accurate-shutdown:
    #     This forces an accurate shutdown when the connection is closed, 
    #     i.e. a SSL close notify alert is send and mod_ssl waits for the
    #     close notify alert of the client. This is 100% SSL/TLS standard
    #     compliant, but in practice often causes hanging connections with
    #     brain-dead browsers. Use this only for browsers where you know
    #     that their SSL implementation works correctly. 
    #   Notice: Most problems of broken clients are also related to the
    #   HTTP keep-alive facility, so you usually additionally want to
    #   disable keep-alive for those clients, too. Use variable
    #   "nokeepalive" for this.
    #   Similarly, one has to force some clients to use HTTP/1.0 to
    #   workaround their broken HTTP/1.1 implementation. Use variables
    #   "downgrade-1.0" and "force-response-1.0" for this.
    #
    # NB: The default setting of degrading ALL IE versions to 1.0 and no
    # keepalive is way too harsh. Changed to only include the unclean shutdown
    # which is still there at least in IE 6-9
    #SetEnvIf User-Agent ".*MSIE.*" \
    #    nokeepalive ssl-unclean-shutdown \
    #    downgrade-1.0 force-response-1.0
    #SetEnvIf User-Agent ".*MSIE.*" \
    SetEnvIf User-Agent ".*MSIE [6-9].*" \
        ssl-unclean-shutdown

    # Disable old weak SSL implementations
    SSLProtocol All -SSLv2 -SSLv3
    SSLProxyProtocol All -SSLv2 -SSLv3

    # Prevent the CRIME attack vector completely
    # SSLCompression option requires apache 2.2.24+
    <IfVersion >= 2.4>
        SSLCompression off
    </IfVersion>
    <IfVersion < 2.4>
        # Fall back to backwards compatible Location method if not recent
        <Location />
           SetEnv no-gzip
        </Location>
    </IfVersion>

</IfModule>

# Configure ordinary virtual host
<VirtualHost __PUBLIC_FQDN__:__PUBLIC_PORT__>
    # General setup for the virtual host
    DocumentRoot "__MIG_STATE__/wwwpublic"
    ErrorLog __APACHE_LOG__/error.log
    CustomLog __APACHE_LOG__/access.log common

    # Rewriting
    RewriteEngine on
    # Notice: Using a high value for RewriteLogLevel will slow down your
    # Apache server dramatically! 
    # Only use a rewrite loglevel greater than (trace)2 for debugging!
    # These were replaced by the general logger in apache>=2.4
    <IfVersion >= 2.4>
        LogLevel notice rewrite:info
    </IfVersion>
    <IfVersion < 2.4>
        RewriteLog __APACHE_LOG__/rewrite.log
        RewriteLogLevel 0
    </IfVersion>

    # Break rewriting chain for commonly-requested final destinations
    RewriteCond %{REQUEST_URI} ^/(favicon.ico|wsgi|cgi|images|public)
    RewriteRule ^ - [L]

    ### VGrid access: Preserve WSGI sessions but fall back to CGI.

    ### Important security guard
    # Catch and reject attempts to execute arbitrary code with a fake vgrid
    # component, using e.g. a custom hgweb.Xgi script manually saved in
    # REALVGRID/mysub/.vgridscm/Xgi-bin/hgweb.Xgi where mysub is an ordinary
    # dir in the VGrid shared REALVGRID dir.
    # The *ScriptAliasMatch will match such requests because they look like
    # legitimate scm requests for a mysub vgrid, so we force redirection if
    # no matching mysub vgrid exists in the user-inaccessible vgrid_home dir.
    # We already prevent setting the executable bit on user home files so
    # fake cgi scripts would not work unless the user also found a way to
    # work around that limitation, but wsgi scripts need not be executable.
    # Thus, this guard is strictly required to protect against fake wsgi sub
    # vgrid components, and it will make cgi exploits harder, too.
    # We silently redirect any such bogus requests to the front page.
    RewriteCond %{REQUEST_URI} ^/vgrid/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$
    RewriteCond __MIG_STATE__/vgrid_home/%1 !-d
    RewriteRule ^/(.*) / [L,R]

    # Redirect to public file in vgrid
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteRule ^/vgrid/(.*)/path/(.*) /vgrid/$1/$2 [L,R]
    
    ### All public vgrid component access is disabled to avoid abuse

    # Redirect to public vgrid components
    #RewriteCond %{REQUEST_URI} ^/vgridpublicscm
    #RewriteCond %{HTTP_REFERER} /wsgi-bin/
    #RewriteRule ^/vgridpublicscm/(.*) /vgrid/$1/.vgridscm/wsgi-bin/hgweb.wsgi [L,R]
    #RewriteCond %{REQUEST_URI} ^/vgridpublicscm
    #RewriteRule ^/vgridpublicscm/(.*) /vgrid/$1/.vgridscm/cgi-bin/hgweb.cgi [L,R]

    #RewriteCond %{REQUEST_URI} ^/vgridpublictracker
    #RewriteCond %{HTTP_REFERER} /wsgi-bin/
    #RewriteRule ^/vgridpublictracker/(.*) /vgrid/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    #RewriteCond %{REQUEST_URI} ^/vgridpublictracker
    #RewriteRule ^/vgridpublictracker/(.*) /vgrid/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # We need to let vgrid component Xgi requests pass through to
    # *ScriptAlias* handlers.
    #RewriteRule ^/vgrid/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /vgrid/$1/$2/$3/$4 [L,PT]

    # Public vgrid component scripts
    #ScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/cgi-bin/$3
    <IfModule mod_wsgi.c>
        # Public vgrid component access (disabled for now to avoid abuse)
        #WSGIScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/wsgi-bin/$3
    </IfModule>
</VirtualHost>

# Configure SSL with certificates virtual host(s)
<IfDefine MIG_CERT_FQDN>
<VirtualHost ${MIG_CERT_FQDN}:__MIG_CERT_PORT__>
    # General setup for the virtual host
    ServerName ${MIG_CERT_FQDN}
    # Enable the next line if you want common aliasing for public address
    __SERVERALIAS_CLAUSE__ __BASE_FQDN__
    DocumentRoot "__MIG_STATE__/user_home"
    ErrorLog __APACHE_LOG__/ssl-cert-error.log
    CustomLog __APACHE_LOG__/ssl-cert-access.log common

    # Optional per-vhost certificate setup for use with externally signed certs
    # IMPORTANT: we split CA setup to allow both client and server cert check.
    # We only override SSLCertificateChainFile *not* SSLCACertificateFile from
    # above. Thus clients can check server cert while we verify clients certs
    # against our own CA.
    __VHOSTCERTS_COMMENTED__SSLCertificateFile __MIG_CERTS__/${MIG_CERT_FQDN}/server.crt
    __VHOSTCERTS_COMMENTED__SSLCertificateKeyFile __MIG_CERTS__/${MIG_CERT_FQDN}/server.key
    __VHOSTCERTS_COMMENTED__SSLCertificateChainFile __MIG_CERTS__/${MIG_CERT_FQDN}/server.ca.pem

    # Keep cgi-cert name for backwards compatibility but point it
    # to cgi-bin
    ScriptAlias /cgi-cert/ "__MIG_CODE__/cgi-bin/"
    ScriptAlias /cgi-bin/ "__MIG_CODE__/cgi-bin/"
    ScriptAlias /cgi-sid/ "__MIG_CODE__/cgi-sid/"

    <IfModule mod_headers.c>
        # Use HSTS if enabled
        __HSTS_COMMENTED__Header always set Strict-Transport-Security "max-age=15768000"
        # As a precaution apply proxy limit in line with security advisory on:
        # http://www.apache.org/security/asf-httpoxy-response.txt
        RequestHeader unset Proxy early
    </IfModule>

    <IfModule mod_wsgi.c>
        WSGIScriptAlias /wsgi-bin "__MIG_CODE__/wsgi-bin/migwsgi.py"
        # Optional software repository from grid.dk (partial checkout)
        WSGIScriptAlias /software-repository "__MIG_CODE__/software-repository/swrepo.py"
    </IfModule>
    
    #   SSL Engine Switch:
    #   Enable/Disable SSL for this virtual host.
    SSLEngine on

    # SSL options that depend on which virtual host is used
    #   Client Authentication (Type):
    #   Client certificate verification type and depth.  Types are
    #   none, optional, require and optional_no_ca.  Depth is a
    #   number which specifies how deeply to verify the certificate
    #   issuer chain before deciding the certificate is not valid.
    SSLVerifyClient require
    SSLVerifyDepth 10

    # Pass cert DN as REMOTE_USER env for symmetry with openid login
    SSLUserName SSL_CLIENT_S_DN

    # Rewriting
    RewriteEngine on
    # Notice: Using a high value for RewriteLogLevel will slow down your
    # Apache server dramatically! 
    # Only use a rewrite loglevel greater than (trace)2 for debugging!
    # These were replaced by the general logger in apache>=2.4
    <IfVersion >= 2.4>
        LogLevel notice rewrite:info
    </IfVersion>
    <IfVersion < 2.4>
        RewriteLog __APACHE_LOG__/ssl-cert-rewrite.log
        RewriteLogLevel 0
    </IfVersion>
    
    # Break rewriting chain for commonly-requested final destinations
    RewriteCond %{REQUEST_URI} ^/(favicon.ico|wsgi|cgi|images|public)
    RewriteRule ^ - [L]

    # Prevent trace and track requests from leaking information
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]

    ### VGrid access: Preserve WSGI sessions but fall back to CGI.

    ### Important security guard
    # Catch and reject attempts to execute arbitrary code with a fake vgrid
    # component, using e.g. a custom hgweb.Xgi script manually saved in
    # REALVGRID/mysub/.vgridscm/Xgi-bin/hgweb.Xgi where mysub is an ordinary
    # dir in the VGrid shared REALVGRID dir.
    # The *ScriptAliasMatch will match such requests because they look like
    # legitimate scm requests for a mysub vgrid, so we force redirection if
    # no matching mysub vgrid exists in the user-inaccessible vgrid_home dir.
    # We already prevent setting the executable bit on user home files so
    # fake cgi scripts would not work unless the user also found a way to
    # work around that limitation, but wsgi scripts need not be executable.
    # Thus, this guard is strictly required to protect against fake wsgi sub
    # vgrid components, and it will make cgi exploits harder, too.
    # We silently redirect any such bogus requests to the front page.
    RewriteCond %{REQUEST_URI} ^/([^/]+)/(vgrid_shared|private_base|public_base)/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$
    RewriteCond __MIG_STATE__/vgrid_home/%3 !-d
    RewriteRule ^/(.*) / [L,R]

    # Redirect to private file in vgrid
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgrid/(.*)/path/(.*) /wsgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=$2 [L,R]
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteRule ^/vgrid/(.*)/path/(.*) /cgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=$2 [L,R]
    # if the "path" is missing, go to top level:
    # (if there was one, the previous rewrite rule has transformed it)
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/$
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgrid/(.*)/$ /wsgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=index.html [L,R]
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/$
    RewriteRule ^/vgrid/(.*)/$ /cgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=index.html [L,R]

    # Redirect to member/owner scm in vgrid - we need to introduce a
    # vgrid_shared to be able to discriminate between vgridscm dir and
    # normal dirs in rewrite
    RewriteCond %{REQUEST_URI} ^/vgridscm
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridscm/(.*) /cert_redirect/vgrid_shared/$1/.vgridscm/wsgi-bin/hgweb.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridscm
    RewriteRule ^/vgridscm/(.*) /cert_redirect/vgrid_shared/$1/.vgridscm/cgi-bin/hgweb.cgi [L,R]

    # Redirect to owner scm in vgrid
    RewriteCond %{REQUEST_URI} ^/vgridownerscm
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridownerscm/(.*) /cert_redirect/private_base/$1/.vgridscm/wsgi-bin/hgweb.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridownerscm
    RewriteRule ^/vgridownerscm/(.*) /cert_redirect/private_base/$1/.vgridscm/cgi-bin/hgweb.cgi [L,R]

    # Redirect to member/owner tracker in vgrid - we need to introduce a
    # vgrid_shared to be able to discriminate between vgridtracker dir and
    # normal dirs in rewrite.
    RewriteCond %{REQUEST_URI} ^/vgridtracker
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridtracker/(.*) /cert_redirect/vgrid_shared/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridtracker
    RewriteRule ^/vgridtracker/(.*) /cert_redirect/vgrid_shared/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # Redirect to owner tracker in vgrid
    RewriteCond %{REQUEST_URI} ^/vgridownertracker
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridownertracker/(.*) /cert_redirect/private_base/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridownertracker
    RewriteRule ^/vgridownertracker/(.*) /cert_redirect/private_base/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # Redirect server status requests to /SERVER_NAME/SERVERNAME.status
    RewriteCond %{REQUEST_URI} ^/server_status
    RewriteRule ^/server_status /%{SERVER_NAME}/%{SERVER_NAME}.status [NE,L]

    ######################################################################
    ######################################################################

    # Redirect user GET file with cert_redirect in request to users home
    # dir.
    # Get the DN from the certificate of the user.
    #
    # Rewrite DN slightly to match the actual file system homes. I.e.
    # replace space with underscore and slash with plus in certificate DN.
    #
    # As an example we want the PATH for the user with DN: 
    # /C=DK/ST=NA/L=NA/O=DIKU/OU=NA/CN=Jonas Bardino/emailAddress=bardino@diku.dk
    # to be mapped to 
    # /+C=DK+ST=NA+L=NA+O=DIKU+OU=NA+CN=Jonas_Bardino+emailAddress=bardino@diku.dk/PATH
    # 
    # Access is restricted with htaccess file in user homes so nothing to
    # worry about in relation to users spoofing rewrite targets.

    # Set up some escape helpers

    RewriteMap escape int:escape
    RewriteMap unescape int:unescape

    # Careful to avoid breakage with exotic chars like percent in filenames. 
    # Prepend certificate DN so that we can modify it further without PATH
    # interference.
    # We rename cert_redirect and finish with N(ext) rather than C(hain) to
    # avoid looping forever on the escape and delayed DN lookup rules. 

    RewriteCond %{REQUEST_URI} ^/cert_redirect/
    RewriteRule ^/cert_redirect/(.*) /cert_mangle/${escape:$1} [C]
    RewriteRule ^/cert_mangle/(.*) %{LA-U:ENV:SSL_CLIENT_S_DN}/cert_mangle/$1 [NE,N]

    # Keep replacing space in DN with underscore
    
    RewriteRule ^(.*)\ (.*)/cert_mangle/(.*)$ $1_$2/cert_mangle/$3 [N]
    
    # Keep replacing slash in DN with plus
    
    RewriteRule ^(.*)/(.*)/cert_mangle/(.*)$ $1+$2/cert_mangle/$3 [N]

    # Keep replacing double backslash from utf8 chars in DN with actual char
    # E.g. to replace the 'oslash' letter on the form \\xC3\\xB8 with %C3%B8

    RewriteRule ^(.*)\\x(..)(.*)/cert_mangle/(.*)$ $1${unescape:%$2}$3/cert_mangle/$4 [N]

    # Finally remove certificate marker and unescape previously escaped path
    RewriteRule ^(.+)/cert_mangle/(.*)$ /$1/${unescape:$2} [N]
    
    ######################################################################
    ######################################################################
    
    # We need to let vgrid wiki cgi requests pass through to *ScriptAlias*
    # handlers.
    # NB: first regex group *must* match DNs only - not '.*'!
    RewriteRule ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /$1/private_base/$2/$3/$4/$5 [L,PT]
    RewriteRule ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /$1/vgrid_shared/$2/$3/$4/$5 [L,PT]

    <Directory "__MIG_CODE__/cgi-bin">
        SSLOptions +StdEnvVars
        Options +ExecCGI
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    # WSGI interface (only visible if mod_wsgi is loaded)
    <Directory "__MIG_CODE__/wsgi-bin">
        SSLOptions +StdEnvVars
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_CODE__/software-repository">
        SSLOptions +StdEnvVars
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_CODE__/cgi-sid">
        SSLOptions +StdEnvVars
        Options +ExecCGI
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_STATE__/user_home">
        # User home base is used for a number of public images and
        # templates.
        # Require a valid signed certificate for access to home base
        # and to individual user sub directories.
        # Access to user home dirs is further limited in .htaccess
        # files there.
        # The next line is crucial for cert_redirect to work!!!
        SSLOptions +StdEnvVars +ExportCertData
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_STATE__/user_home/*/">
        # Enable cert based auth with .htaccess file
        AllowOverride AuthConfig
    </Directory>
    <Directory "__MIG_STATE__/user_home/*/*/">
        # Do not allow or waste time on any nested htaccess files
        AllowOverride None
    </Directory>

    # BEGIN OPTIONAL MiG VGrid TRAC PROJECT TRACKER
    #
    # Use email from certificate DN for semi-automatic Trac login:
    # http://trac.edgewall.org/wiki/TracClientCertificates
    # We use email because we want it to be short and unique, but any field
    # on http://httpd.apache.org/docs/current/mod/mod_ssl.html should work.
    # Changes here requires sync with the trac_id_field MiG conf option.
    #
    # Common mappings from Apache to MiG conf:
    # SSL_CLIENT_S_DN -> distinguished_name
    # SSL_CLIENT_S_DN_Email -> email
    # SSL_CLIENT_S_DN_CN -> full_name
    # SSL_CLIENT_S_DN_O -> organization
    <LocationMatch /[^/]+gi-bin/trac.[^/]+gi>
        SSLUserName SSL_CLIENT_S_DN_Email
    </LocationMatch>
    # END OPTIONAL MiG VGrid TRAC PROJECT TRACKER

    #######################################################################
    # IMPORTANT: Never allow users writing in these cgi-bin's in any way! #
    # It would leave a remote execution hole open for all VGrid members.  #
    #######################################################################

    # Public vgrid component access (disabled for now to avoid abuse)
    #ScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/cgi-bin/$3
    # Home directory vgrid component access - we need to avoid catching raw
    # cert_redirect URLs
    ScriptAliasMatch ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/user_home/$1/private_base/$2/$3/cgi-bin/$4
    ScriptAliasMatch ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/user_home/$1/$2/$3/cgi-bin/$4
    <IfModule mod_wsgi.c>
        # Public vgrid component access (disabled for now to avoid abuse)
        #WSGIScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/wsgi-bin/$3
        WSGIScriptAliasMatch ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/user_home/$1/private_base/$2/$3/wsgi-bin/$4
        WSGIScriptAliasMatch ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/user_home/$1/$2/$3/wsgi-bin/$4
    </IfModule>


    ### Seafile (optional)
    
    # NOTE: seahub exposed here as well for sign-up integration without 
    #       XSS/CSRF prevention issues

    # Seafile media files - rely on symlink to latest install
    __SEAFILE_COMMENTED__ Alias /seafmedia /home/mig/seafile/seafile-server-latest/seahub/media
    __SEAFILE_COMMENTED__ <Location /seafmedia>
    __SEAFILE_COMMENTED__     <IfVersion >= 2.4>
    __SEAFILE_COMMENTED__         Require all granted 
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__     <IfVersion < 2.4>
    __SEAFILE_COMMENTED__         Order allow,deny
    __SEAFILE_COMMENTED__         Allow from all
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__ </Location>

    # Expose seahub with method from https://github.com/haiwen/seafile/issues/1186
    # rather than the mod_fastcgi setup suggested in official docs
    # since CentOS does not include the ancient mod_fastcgi and recommends
    # mod_proxy_fcgi instead

    __SEAFILE_COMMENTED__ SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1

    #
    # Seafile file server
    #
    __SEAFILE_COMMENTED__ ProxyPass /seafhttp http://127.0.0.1:8082
    __SEAFILE_COMMENTED__ ProxyPassReverse /seafhttp http://127.0.0.1:8082

    #
    # Seahub web interface
    #
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1
    __SEAFILE_COMMENTED__ ProxyPass "/seafile" "fcgi://127.0.0.1:8000/seafile"

    ### ParaViewWeb (optional

    # Have Apache pass these requests to the ParaViewWeb launcher
    __PREVIEW_COMMENTED__ ProxyPass /paraview http://localhost:8080/paraview

    # This is the path of the mapping file
    __PREVIEW_COMMENTED__ RewriteMap session-to-port txt:__MIG_STATE__/paraview_home/launcher/proxy.txt

    # This is the rewrite condition.
    # Look for anything with a sessionId=
    # in the query part of the URL and capture the value to use below.
    __PREVIEW_COMMENTED__ RewriteCond %{QUERY_STRING} ^sessionId=(.*)$ [NC]

    # This does the rewrite using the mapping file and the sessionId
    __PREVIEW_COMMENTED__ RewriteRule ^/proxy.*$  ws://${session-to-port:%1}/ws [P]

</VirtualHost>
</IfDefine>

<IfDefine EXT_CERT_FQDN>
<VirtualHost ${EXT_CERT_FQDN}:__EXT_CERT_PORT__>
    # General setup for the virtual host
    ServerName ${EXT_CERT_FQDN}
    # Enable the next line if you want common aliasing for public address
    __SERVERALIAS_CLAUSE__ __BASE_FQDN__
    DocumentRoot "__MIG_STATE__/user_home"
    ErrorLog __APACHE_LOG__/ssl-cert-error.log
    CustomLog __APACHE_LOG__/ssl-cert-access.log common

    # Optional per-vhost certificate setup for use with externally signed certs
    # IMPORTANT: we split CA setup to allow both client and server cert check.
    # We only override SSLCertificateChainFile *not* SSLCACertificateFile from
    # above. Thus clients can check server cert while we verify clients certs
    # against our own CA.
    __VHOSTCERTS_COMMENTED__SSLCertificateFile __MIG_CERTS__/${EXT_CERT_FQDN}/server.crt
    __VHOSTCERTS_COMMENTED__SSLCertificateKeyFile __MIG_CERTS__/${EXT_CERT_FQDN}/server.key
    __VHOSTCERTS_COMMENTED__SSLCertificateChainFile __MIG_CERTS__/${EXT_CERT_FQDN}/server.ca.pem

    # Keep cgi-cert name for backwards compatibility but point it
    # to cgi-bin
    ScriptAlias /cgi-cert/ "__MIG_CODE__/cgi-bin/"
    ScriptAlias /cgi-bin/ "__MIG_CODE__/cgi-bin/"
    ScriptAlias /cgi-sid/ "__MIG_CODE__/cgi-sid/"

    <IfModule mod_headers.c>
        # Use HSTS if enabled
        __HSTS_COMMENTED__Header always set Strict-Transport-Security "max-age=15768000"
        # As a precaution apply proxy limit in line with security advisory on:
        # http://www.apache.org/security/asf-httpoxy-response.txt
        RequestHeader unset Proxy early
    </IfModule>

    <IfModule mod_wsgi.c>
        WSGIScriptAlias /wsgi-bin "__MIG_CODE__/wsgi-bin/migwsgi.py"
        # Optional software repository from grid.dk (partial checkout)
        WSGIScriptAlias /software-repository "__MIG_CODE__/software-repository/swrepo.py"
    </IfModule>
    
    #   SSL Engine Switch:
    #   Enable/Disable SSL for this virtual host.
    SSLEngine on

    # SSL options that depend on which virtual host is used
    #   Client Authentication (Type):
    #   Client certificate verification type and depth.  Types are
    #   none, optional, require and optional_no_ca.  Depth is a
    #   number which specifies how deeply to verify the certificate
    #   issuer chain before deciding the certificate is not valid.
    SSLVerifyClient require
    SSLVerifyDepth 10

    # Pass cert DN as REMOTE_USER env for symmetry with openid login
    SSLUserName SSL_CLIENT_S_DN

    # Rewriting
    RewriteEngine on
    # Notice: Using a high value for RewriteLogLevel will slow down your
    # Apache server dramatically! 
    # Only use a rewrite loglevel greater than (trace)2 for debugging!
    # These were replaced by the general logger in apache>=2.4
    <IfVersion >= 2.4>
        LogLevel notice rewrite:info
    </IfVersion>
    <IfVersion < 2.4>
        RewriteLog __APACHE_LOG__/ssl-cert-rewrite.log
        RewriteLogLevel 0
    </IfVersion>
    
    # Break rewriting chain for commonly-requested final destinations
    RewriteCond %{REQUEST_URI} ^/(favicon.ico|wsgi|cgi|images|public)
    RewriteRule ^ - [L]

    # Prevent trace and track requests from leaking information
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]

    ### VGrid access: Preserve WSGI sessions but fall back to CGI.

    ### Important security guard
    # Catch and reject attempts to execute arbitrary code with a fake vgrid
    # component, using e.g. a custom hgweb.Xgi script manually saved in
    # REALVGRID/mysub/.vgridscm/Xgi-bin/hgweb.Xgi where mysub is an ordinary
    # dir in the VGrid shared REALVGRID dir.
    # The *ScriptAliasMatch will match such requests because they look like
    # legitimate scm requests for a mysub vgrid, so we force redirection if
    # no matching mysub vgrid exists in the user-inaccessible vgrid_home dir.
    # We already prevent setting the executable bit on user home files so
    # fake cgi scripts would not work unless the user also found a way to
    # work around that limitation, but wsgi scripts need not be executable.
    # Thus, this guard is strictly required to protect against fake wsgi sub
    # vgrid components, and it will make cgi exploits harder, too.
    # We silently redirect any such bogus requests to the front page.
    RewriteCond %{REQUEST_URI} ^/([^/]+)/(vgrid_shared|private_base|public_base)/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$
    RewriteCond __MIG_STATE__/vgrid_home/%3 !-d
    RewriteRule ^/(.*) / [L,R]

    # Redirect to private file in vgrid
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgrid/(.*)/path/(.*) /wsgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=$2 [L,R]
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteRule ^/vgrid/(.*)/path/(.*) /cgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=$2 [L,R]
    # if the "path" is missing, go to top level:
    # (if there was one, the previous rewrite rule has transformed it)
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/$
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgrid/(.*)/$ /wsgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=index.html [L,R]
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/$
    RewriteRule ^/vgrid/(.*)/$ /cgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=index.html [L,R]

    # Redirect to member/owner scm in vgrid - we need to introduce a
    # vgrid_shared to be able to discriminate between vgridscm dir and
    # normal dirs in rewrite
    RewriteCond %{REQUEST_URI} ^/vgridscm
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridscm/(.*) /cert_redirect/vgrid_shared/$1/.vgridscm/wsgi-bin/hgweb.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridscm
    RewriteRule ^/vgridscm/(.*) /cert_redirect/vgrid_shared/$1/.vgridscm/cgi-bin/hgweb.cgi [L,R]

    # Redirect to owner scm in vgrid
    RewriteCond %{REQUEST_URI} ^/vgridownerscm
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridownerscm/(.*) /cert_redirect/private_base/$1/.vgridscm/wsgi-bin/hgweb.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridownerscm
    RewriteRule ^/vgridownerscm/(.*) /cert_redirect/private_base/$1/.vgridscm/cgi-bin/hgweb.cgi [L,R]

    # Redirect to member/owner tracker in vgrid - we need to introduce a
    # vgrid_shared to be able to discriminate between vgridtracker dir and
    # normal dirs in rewrite.
    RewriteCond %{REQUEST_URI} ^/vgridtracker
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridtracker/(.*) /cert_redirect/vgrid_shared/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridtracker
    RewriteRule ^/vgridtracker/(.*) /cert_redirect/vgrid_shared/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # Redirect to owner tracker in vgrid
    RewriteCond %{REQUEST_URI} ^/vgridownertracker
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridownertracker/(.*) /cert_redirect/private_base/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridownertracker
    RewriteRule ^/vgridownertracker/(.*) /cert_redirect/private_base/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # Redirect server status requests to /SERVER_NAME/SERVERNAME.status
    RewriteCond %{REQUEST_URI} ^/server_status
    RewriteRule ^/server_status /%{SERVER_NAME}/%{SERVER_NAME}.status [NE,L]

    ######################################################################
    ######################################################################

    # Redirect user GET file with cert_redirect in request to users home
    # dir.
    # Get the DN from the certificate of the user.
    #
    # Rewrite DN slightly to match the actual file system homes. I.e.
    # replace space with underscore and slash with plus in certificate DN.
    #
    # As an example we want the PATH for the user with DN: 
    # /C=DK/ST=NA/L=NA/O=DIKU/OU=NA/CN=Jonas Bardino/emailAddress=bardino@diku.dk
    # to be mapped to 
    # /+C=DK+ST=NA+L=NA+O=DIKU+OU=NA+CN=Jonas_Bardino+emailAddress=bardino@diku.dk/PATH
    # 
    # Access is restricted with htaccess file in user homes so nothing to
    # worry about in relation to users spoofing rewrite targets.

    # Set up some escape helpers

    RewriteMap escape int:escape
    RewriteMap unescape int:unescape

    # Careful to avoid breakage with exotic chars like percent in filenames. 
    # Prepend certificate DN so that we can modify it further without PATH
    # interference.
    # We rename cert_redirect and finish with N(ext) rather than C(hain) to
    # avoid looping forever on the escape and delayed DN lookup rules. 

    RewriteCond %{REQUEST_URI} ^/cert_redirect/
    RewriteRule ^/cert_redirect/(.*) /cert_mangle/${escape:$1} [C]
    RewriteRule ^/cert_mangle/(.*) %{LA-U:ENV:SSL_CLIENT_S_DN}/cert_mangle/$1 [NE,N]

    # Keep replacing space in DN with underscore
    
    RewriteRule ^(.*)\ (.*)/cert_mangle/(.*)$ $1_$2/cert_mangle/$3 [N]
    
    # Keep replacing slash in DN with plus
    
    RewriteRule ^(.*)/(.*)/cert_mangle/(.*)$ $1+$2/cert_mangle/$3 [N]

    # Keep replacing double backslash from utf8 chars in DN with actual char
    # E.g. to replace the 'oslash' letter on the form \\xC3\\xB8 with %C3%B8

    RewriteRule ^(.*)\\x(..)(.*)/cert_mangle/(.*)$ $1${unescape:%$2}$3/cert_mangle/$4 [N]

    # Finally remove certificate marker and unescape previously escaped path
    RewriteRule ^(.+)/cert_mangle/(.*)$ /$1/${unescape:$2} [N]
    
    ######################################################################
    ######################################################################
    
    # We need to let vgrid wiki cgi requests pass through to *ScriptAlias*
    # handlers.
    # NB: first regex group *must* match DNs only - not '.*'!
    RewriteRule ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /$1/private_base/$2/$3/$4/$5 [L,PT]
    RewriteRule ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /$1/vgrid_shared/$2/$3/$4/$5 [L,PT]

    <Directory "__MIG_CODE__/cgi-bin">
        SSLOptions +StdEnvVars
        Options +ExecCGI
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    # WSGI interface (only visible if mod_wsgi is loaded)
    <Directory "__MIG_CODE__/wsgi-bin">
        SSLOptions +StdEnvVars
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_CODE__/software-repository">
        SSLOptions +StdEnvVars
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_CODE__/cgi-sid">
        SSLOptions +StdEnvVars
        Options +ExecCGI
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_STATE__/user_home">
        # User home base is used for a number of public images and
        # templates.
        # Require a valid signed certificate for access to home base
        # and to individual user sub directories.
        # Access to user home dirs is further limited in .htaccess
        # files there.
        # The next line is crucial for cert_redirect to work!!!
        SSLOptions +StdEnvVars +ExportCertData
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_STATE__/user_home/*/">
        # Enable cert based auth with .htaccess file
        AllowOverride AuthConfig
    </Directory>
    <Directory "__MIG_STATE__/user_home/*/*/">
        # Do not allow or waste time on any nested htaccess files
        AllowOverride None
    </Directory>

    # BEGIN OPTIONAL MiG VGrid TRAC PROJECT TRACKER
    #
    # Use email from certificate DN for semi-automatic Trac login:
    # http://trac.edgewall.org/wiki/TracClientCertificates
    # We use email because we want it to be short and unique, but any field
    # on http://httpd.apache.org/docs/current/mod/mod_ssl.html should work.
    # Changes here requires sync with the trac_id_field MiG conf option.
    #
    # Common mappings from Apache to MiG conf:
    # SSL_CLIENT_S_DN -> distinguished_name
    # SSL_CLIENT_S_DN_Email -> email
    # SSL_CLIENT_S_DN_CN -> full_name
    # SSL_CLIENT_S_DN_O -> organization
    <LocationMatch /[^/]+gi-bin/trac.[^/]+gi>
        SSLUserName SSL_CLIENT_S_DN_Email
    </LocationMatch>
    # END OPTIONAL MiG VGrid TRAC PROJECT TRACKER

    #######################################################################
    # IMPORTANT: Never allow users writing in these cgi-bin's in any way! #
    # It would leave a remote execution hole open for all VGrid members.  #
    #######################################################################

    # Public vgrid component access (disabled for now to avoid abuse)
    #ScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/cgi-bin/$3
    # Home directory vgrid component access - we need to avoid catching raw
    # cert_redirect URLs
    ScriptAliasMatch ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/user_home/$1/private_base/$2/$3/cgi-bin/$4
    ScriptAliasMatch ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/user_home/$1/$2/$3/cgi-bin/$4
    <IfModule mod_wsgi.c>
        # Public vgrid component access (disabled for now to avoid abuse)
        #WSGIScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/wsgi-bin/$3
        WSGIScriptAliasMatch ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/user_home/$1/private_base/$2/$3/wsgi-bin/$4
        WSGIScriptAliasMatch ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/user_home/$1/$2/$3/wsgi-bin/$4
    </IfModule>


    ### Seafile (optional)
    
    # NOTE: seahub exposed here as well for sign-up integration without 
    #       XSS/CSRF prevention issues

    # Seafile media files - rely on symlink to latest install
    __SEAFILE_COMMENTED__ Alias /seafmedia /home/mig/seafile/seafile-server-latest/seahub/media
    __SEAFILE_COMMENTED__ <Location /seafmedia>
    __SEAFILE_COMMENTED__     <IfVersion >= 2.4>
    __SEAFILE_COMMENTED__         Require all granted 
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__     <IfVersion < 2.4>
    __SEAFILE_COMMENTED__         Order allow,deny
    __SEAFILE_COMMENTED__         Allow from all
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__ </Location>

    # Expose seahub with method from https://github.com/haiwen/seafile/issues/1186
    # rather than the mod_fastcgi setup suggested in official docs
    # since CentOS does not include the ancient mod_fastcgi and recommends
    # mod_proxy_fcgi instead

    __SEAFILE_COMMENTED__ SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1

    #
    # Seafile file server
    #
    __SEAFILE_COMMENTED__ ProxyPass /seafhttp http://127.0.0.1:8082
    __SEAFILE_COMMENTED__ ProxyPassReverse /seafhttp http://127.0.0.1:8082

    #
    # Seahub web interface
    #
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1
    __SEAFILE_COMMENTED__ ProxyPass "/seafile" "fcgi://127.0.0.1:8000/seafile"

    ### ParaViewWeb (optional

    # Have Apache pass these requests to the ParaViewWeb launcher
    __PREVIEW_COMMENTED__ ProxyPass /paraview http://localhost:8080/paraview

    # This is the path of the mapping file
    __PREVIEW_COMMENTED__ RewriteMap session-to-port txt:__MIG_STATE__/paraview_home/launcher/proxy.txt

    # This is the rewrite condition.
    # Look for anything with a sessionId=
    # in the query part of the URL and capture the value to use below.
    __PREVIEW_COMMENTED__ RewriteCond %{QUERY_STRING} ^sessionId=(.*)$ [NC]

    # This does the rewrite using the mapping file and the sessionId
    __PREVIEW_COMMENTED__ RewriteRule ^/proxy.*$  ws://${session-to-port:%1}/ws [P]

</VirtualHost>
</IfDefine>


<IfModule mod_auth_openid.cpp>
# Configure SSL with openid virtual host(s) if enabled

<IfDefine MIG_OID_FQDN>
# SSL with OpenID access based on user login against local MiG user DB
<VirtualHost ${MIG_OID_FQDN}:__MIG_OID_PORT__>
    # General setup for the virtual host
    ServerName ${MIG_OID_FQDN}
    # Enable the next line if you want common aliasing for public address
    __SERVERALIAS_CLAUSE__ __BASE_FQDN__
    DocumentRoot "__MIG_STATE__/user_home"
    ErrorLog __APACHE_LOG__/ssl-oid-error.log
    CustomLog __APACHE_LOG__/ssl-oid-access.log common

    # Optional per-vhost certificate setup for use with externally signed certs
    # IMPORTANT: we split CA setup to allow both client and server cert check.
    # We only override SSLCertificateChainFile *not* SSLCACertificateFile from
    # above. Thus clients can check server cert while we verify clients certs
    # against our own CA.
    __VHOSTCERTS_COMMENTED__SSLCertificateFile __MIG_CERTS__/${MIG_OID_FQDN}/server.crt
    __VHOSTCERTS_COMMENTED__SSLCertificateKeyFile __MIG_CERTS__/${MIG_OID_FQDN}/server.key
    __VHOSTCERTS_COMMENTED__SSLCertificateChainFile __MIG_CERTS__/${MIG_OID_FQDN}/server.ca.pem

    # OpenID-based access to cgi-bin (see below)
    ScriptAlias /cgi-oid/ "__MIG_CODE__/cgi-bin/"
    ScriptAlias /cgi-bin/ "__MIG_CODE__/cgi-bin/"
    ScriptAlias /cgi-sid/ "__MIG_CODE__/cgi-sid/"

    <IfModule mod_headers.c>
        # Use HSTS if enabled
        __HSTS_COMMENTED__Header always set Strict-Transport-Security "max-age=15768000"
        # OpenID 2.0's relying party verification mechanism requires this header
        Header always set X-XRDS-Location "https://__SID_FQDN__:__SID_PORT__/cgi-sid/oiddiscover.py"
        # As a precaution apply proxy limit in line with security advisory on:
        # http://www.apache.org/security/asf-httpoxy-response.txt
        RequestHeader unset Proxy early
    </IfModule>

    <IfModule mod_wsgi.c>
        WSGIScriptAlias /wsgi-bin "__MIG_CODE__/wsgi-bin/migwsgi.py"
        # Optional software repository from grid.dk (partial checkout)
        WSGIScriptAlias /software-repository "__MIG_CODE__/software-repository/swrepo.py"
    </IfModule>
    
    #   SSL Engine Switch:
    #   Enable/Disable SSL for this virtual host.
    SSLEngine on

    # SSL options that depend on which virtual host is used
    #   Client Authentication (Type):
    #   Client certificate verification type and depth.  Types are
    #   none, optional, require and optional_no_ca.  Depth is a
    #   number which specifies how deeply to verify the certificate
    #   issuer chain before deciding the certificate is not valid.
    SSLVerifyClient none

    # Transfer raw OpenID username to new MIG_OID_USERNAME env for use in
    # rewrites and htaccess
    SetEnvIf %{LU-A:REMOTE_USER} ^.*/([^/]+)$ MIG_OID_USERNAME="$1"

    ### Any special directories without openid requirement should go here...

    # Currently no such dirs except the globally configured ones at the top


    #### All other locations share basic OpenID conf and can use SSL envs

    <Directory "__MIG_BASE__/">
        # Where to store OpenID user session DB - must be read/write
        # to web server user (__USER__)
        # Use custom location since some distros do not allow r/w in
        # apache run dir causing mod auth openid to segfault :-(
        AuthOpenIDDBLocation __MIG_STATE__/openid_store/__MIG_OID_AUTH_DB__
        AuthOpenIDSecureCookie On
        # Default to 12 hours of access without re-login
        AuthOpenIDCookieLifespan 43200
        # We only use login page for user friendly OpenID error handling
        AuthOpenIDLoginPage https://__SID_FQDN__:__SID_PORT__/cgi-sid/login.py
        # Require auth by our own OpenID server and use the base URL
        # in order to have manual user ID selection
        AuthOpenIDSingleIdP __MIG_OID_PROVIDER_BASE__
        # Single-sign-on by forcing trust root and cookie path to server base
        AuthOpenIDTrustRoot https://${MIG_OID_FQDN}/
        AuthOpenIDCookiePath /
        # Pass SSL variables on
        SSLOptions +StdEnvVars
    </Directory>

    ### The rest are sub-dirs that inherit the general conf above and
    ### they can override any settings explicitly

    <Directory "__MIG_CODE__/cgi-bin">
        Options +ExecCGI
        AuthType OpenID
        require valid-user
        # Remove source address based access limitations here
        # NOTE: no entry for 2.4+ here since it disables auth
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    # WSGI interface (only visible if mod_wsgi is loaded)
    <Directory "__MIG_CODE__/wsgi-bin">
        AuthType OpenID
        require valid-user
        # Remove source address based access limitations here
        # NOTE: no entry for 2.4+ here since it disables auth
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_STATE__/user_home/">
        # Require a valid OpenID login for access to user home and all user
        # sub directories.
        AuthType OpenID
        require valid-user
        # Access to user home dirs is also further limited in .htaccess
        # files there.
        # Remove source address based access limitations here
        # NOTE: no entry for 2.4+ here since it disables auth
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_STATE__/user_home/*/">
        # Add additional auth restrictions with .htaccess file
        AllowOverride AuthConfig
    </Directory>
    <Directory "__MIG_STATE__/user_home/*/*/">
        # Do not allow or waste time on any nested htaccess files
        AllowOverride None
    </Directory>
    <LocationMatch "^/(index.html)?$">
        # Grant full access to landing page in user_home so that openid relying
        # party verification can work from index.html without an openid loop. 
        # The access restriction is there on individual user sub directories.
        # In apache-2.2 we must use Satisfy any rather than Authtype None here
        <IfVersion >= 2.4>
            AuthType None
            #Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Satisfy Any
        </IfVersion>
    </LocationMatch>
    # We allow access to cgi-sid with auth here just like for the cert case
    <Directory "__MIG_CODE__/cgi-sid">
        Options +ExecCGI
        AuthType OpenID
        require valid-user
        # Remove source address based access limitations here
        # NOTE: no entry for 2.4+ here since it disables auth
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>

    # BEGIN OPTIONAL MiG VGrid TRAC PROJECT TRACKER
    #
    # TODO: update to use OpenID email as username here?
    #
    # Use email from certificate DN for semi-automatic Trac login:
    # http://trac.edgewall.org/wiki/TracClientCertificates
    # We use email because we want it to be short and unique, but any field
    # on http://httpd.apache.org/docs/current/mod/mod_ssl.html should work.
    # Changes here requires sync with the trac_id_field MiG conf option.
    #
    # Common mappings from Apache to MiG conf:
    # SSL_CLIENT_S_DN -> distinguished_name
    # SSL_CLIENT_S_DN_Email -> email
    # SSL_CLIENT_S_DN_CN -> full_name
    # SSL_CLIENT_S_DN_O -> organization
    #<LocationMatch /[^/]+gi-bin/trac.[^/]+gi>
    #    SSLUserName SSL_CLIENT_S_DN_Email
    #</LocationMatch>
    # END OPTIONAL MiG VGrid TRAC PROJECT TRACKER

    # Rewriting
    RewriteEngine on
    # Notice: Using a high value for RewriteLogLevel will slow down your
    # Apache server dramatically! 
    # Only use a rewrite loglevel greater than (trace)2 for debugging!
    # These were replaced by the general logger in apache>=2.4
    <IfVersion >= 2.4>
        LogLevel notice rewrite:info
    </IfVersion>
    <IfVersion < 2.4>
        RewriteLog __APACHE_LOG__/ssl-oid-rewrite.log
        RewriteLogLevel 0
    </IfVersion>

    # Filter OpenID SReg noise from query string
    RewriteCond %{QUERY_STRING} ^openid.ns.sreg=http%3A%2F%2Fopenid.net%2Fextensions%2Fsreg%2F1.1$
    RewriteRule ^(.*) $1? [L,R]

    # Break rewriting chain for commonly-requested final destinations
    RewriteCond %{REQUEST_URI} ^/(favicon.ico|wsgi|cgi|images|public)
    RewriteRule ^ - [L]

    # Prevent trace and track requests from leaking information
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]

    ### VGrid access: Preserve WSGI sessions but fall back to CGI.

    ### Important security guard
    # Catch and reject attempts to execute arbitrary code with a fake vgrid
    # component, using e.g. a custom hgweb.Xgi script manually saved in
    # REALVGRID/mysub/.vgridscm/Xgi-bin/hgweb.Xgi where mysub is an ordinary
    # dir in the VGrid shared REALVGRID dir.
    # The *ScriptAliasMatch will match such requests because they look like
    # legitimate scm requests for a mysub vgrid, so we force redirection if
    # no matching mysub vgrid exists in the user-inaccessible vgrid_home dir.
    # We already prevent setting the executable bit on user home files so
    # fake cgi scripts would not work unless the user also found a way to
    # work around that limitation, but wsgi scripts need not be executable.
    # Thus, this guard is strictly required to protect against fake wsgi sub
    # vgrid components, and it will make cgi exploits harder, too.
    # We silently redirect any such bogus requests to the front page.
    RewriteCond %{REQUEST_URI} ^/([^/]+)/(vgrid_shared|private_base|public_base)/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$
    RewriteCond __MIG_STATE__/vgrid_home/%3 !-d
    RewriteRule ^/(.*) / [L,R]

    # Redirect to private file in vgrid
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgrid/(.*)/path/(.*) /wsgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=$2 [L,R]
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteRule ^/vgrid/(.*)/path/(.*) /cgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=$2 [L,R]
    # if the "path" is missing, go to top level:
    # (if there was one, the previous rewrite rule has transformed it)
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/$
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgrid/(.*)/$ /wsgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=index.html [L,R]
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/$
    RewriteRule ^/vgrid/(.*)/$ /cgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=index.html [L,R]

    # Redirect to member/owner tracker in vgrid - we need to introduce a
    # vgrid_shared to be able to discriminate between vgridtracker dir and
    # normal dirs in rewrite.
    RewriteCond %{REQUEST_URI} ^/vgridtracker
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridtracker/(.*) /cert_redirect/vgrid_shared/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridtracker
    RewriteRule ^/vgridtracker/(.*) /cert_redirect/vgrid_shared/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # Redirect to owner tracker in vgrid
    RewriteCond %{REQUEST_URI} ^/vgridownertracker
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridownertracker/(.*) /cert_redirect/private_base/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridownertracker
    RewriteRule ^/vgridownertracker/(.*) /cert_redirect/private_base/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # Redirect server status requests to /SERVER_NAME/SERVERNAME.status
    RewriteCond %{REQUEST_URI} ^/server_status
    RewriteRule ^/server_status /%{SERVER_NAME}/%{SERVER_NAME}.status [NE,L]

    ######################################################################
    ######################################################################

    # Redirect user GET file with cert_redirect in request to users home
    # dir.
    # Get the DN from the certificate of the user.
    #
    # Rewrite DN slightly to match the actual file system homes. I.e.
    # replace space with underscore and slash with plus in certificate DN.
    #
    # As an example we want /cert_redirect/PATH for the user with DN: 
    # /C=DK/ST=NA/L=NA/O=NBI/OU=NA/CN=Jonas Bardino/emailAddress=bardino@nbi.ku.dk
    # to be mapped to 
    # /+C=DK+ST=NA+L=NA+O=NBI+OU=NA+CN=Jonas_Bardino+emailAddress=bardino@nbi.ku.dk/PATH
    # 
    # Access is restricted with htaccess file in user homes so nothing to
    # worry about in relation to users spoofing rewrite targets.

    # Set up some escape helpers

    RewriteMap escape int:escape
    RewriteMap unescape int:unescape

    # Careful to avoid breakage with exotic chars like percent in filenames. 
    # Fake certificate DN so that we can modify it further without PATH
    # interference. It may already be on final format but that doesn't hurt.
    # REMOTE_USER is only available in later stages so we must use 
    # LA-U:REMOTE_USER and it contains the full OpenID URL so we strip the
    # leading prefix until after the https://a.b.c/openid/id/ part.
    # We rename cert_redirect and finish with N(ext) rather than C(hain) to
    # avoid looping forever on the escape and delayed DN lookup rules. 

    RewriteCond %{REQUEST_URI} ^/cert_redirect/
    RewriteRule ^/cert_redirect/(.*) /cert_mangle/${escape:$1} [C]
    RewriteRule ^/cert_mangle/(.*) /strip_provider/%{LA-U:REMOTE_USER}/cert_mangle/$1 [NE,C]
    RewriteRule ^/strip_provider/__MIG_OID_PROVIDER_ID__/*(.+)/cert_mangle/(.*) $1/cert_mangle/$2 [NE,N]

    # Keep replacing space in DN with underscore
    
    RewriteRule ^(.*)\ (.*)/cert_mangle/(.*)$ $1_$2/cert_mangle/$3 [N]
    
    # Keep replacing slash in DN with plus
    
    RewriteRule ^(.*)/(.*)/cert_mangle/(.*)$ $1+$2/cert_mangle/$3 [N]

    # Finally remove certificate marker
    # IMPORTANT: all major browsers have trouble to some extent when accessing
    # the resulting cert_redirect data if we let the rules proceed as in the
    # cert case ([N]). This leads to subtle errors like IE and Chrome returning
    # an error instead of downloading e.g. PDF files when double clicking in
    # Files and FF not actually applying Settings -> style. Strangely enough
    # FF succeeds in the former and Chrome+IE in the latter case.
    # We explicitly SSL proxy ([P]) to work around the issues.
    SSLProxyEngine on
    # For security reasons we prevent Apache from acting like a forward proxy
    ProxyRequests Off
    # Finally remove certificate marker and unescape previously escaped path
    RewriteRule ^(.+)/cert_mangle/(.*)$ /$1/${unescape:$2} [P]
    
    ######################################################################
    ######################################################################
    
    # We need to let vgrid wiki cgi requests pass through to *ScriptAlias*
    # handlers.
    # NB: first regex group *must* match DNs only - not '.*'!
    RewriteRule ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /$1/private_base/$2/$3/$4/$5 [L,PT]
    RewriteRule ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /$1/vgrid_shared/$2/$3/$4/$5 [L,PT]

    #######################################################################
    # IMPORTANT: Never allow users writing in these cgi-bin's in any way! #
    # It would leave a remote execution hole open for all VGrid members.  #
    #######################################################################

    # Public vgrid component access (disabled for now to avoid abuse)
    #ScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/cgi-bin/$3
    # Home directory vgrid component access - we need to avoid catching raw
    # cert_redirect URLs
    ScriptAliasMatch ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/user_home/$1/private_base/$2/$3/cgi-bin/$4
    ScriptAliasMatch ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/user_home/$1/$2/$3/cgi-bin/$4
    <IfModule mod_wsgi.c>
        # Public vgrid component access (disabled for now to avoid abuse)
        #WSGIScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/wsgi-bin/$3
        WSGIScriptAliasMatch ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/user_home/$1/private_base/$2/$3/wsgi-bin/$4
        WSGIScriptAliasMatch ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/user_home/$1/$2/$3/wsgi-bin/$4
    </IfModule>


    # Proxy forward /openid/ to grid_openid daemon running on __IO_FQDN__
    # IMPORTANT: edit ProxyPass port if you edit openid port in MiGserver.conf

    __MIG_OID_PROXY_COMMENTED__ <Location /openid/>
    __MIG_OID_PROXY_COMMENTED__     <IfVersion >= 2.4>
    __MIG_OID_PROXY_COMMENTED__         Require all granted 
    __MIG_OID_PROXY_COMMENTED__     </IfVersion>
    __MIG_OID_PROXY_COMMENTED__     <IfVersion < 2.4>
    __MIG_OID_PROXY_COMMENTED__         Order allow,deny
    __MIG_OID_PROXY_COMMENTED__         Allow from all
    __MIG_OID_PROXY_COMMENTED__     </IfVersion>
    __MIG_OID_PROXY_COMMENTED__ </Location>
    __MIG_OID_PROXY_COMMENTED__ ProxyPass /openid/ https://__IO_FQDN__:8443/openid/
    __MIG_OID_PROXY_COMMENTED__ ProxyPassReverse /openid/ https://__IO_FQDN__:8443/openid/

    ### Seafile (optional)
    
    # NOTE: seahub exposed here as well for sign-up integration without 
    #       XSS/CSRF prevention issues

    # Seafile media files - rely on symlink to latest install
    __SEAFILE_COMMENTED__ Alias /seafmedia /home/mig/seafile/seafile-server-latest/seahub/media
    __SEAFILE_COMMENTED__ <Location /seafmedia>
    __SEAFILE_COMMENTED__     <IfVersion >= 2.4>
    __SEAFILE_COMMENTED__         Require all granted 
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__     <IfVersion < 2.4>
    __SEAFILE_COMMENTED__         Order allow,deny
    __SEAFILE_COMMENTED__         Allow from all
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__ </Location>

    # Expose seahub with method from https://github.com/haiwen/seafile/issues/1186
    # rather than the mod_fastcgi setup suggested in official docs
    # since CentOS does not include the ancient mod_fastcgi and recommends
    # mod_proxy_fcgi instead

    __SEAFILE_COMMENTED__ SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1

    #
    # Seafile file server
    #
    __SEAFILE_COMMENTED__ ProxyPass /seafhttp http://127.0.0.1:8082
    __SEAFILE_COMMENTED__ ProxyPassReverse /seafhttp http://127.0.0.1:8082

    #
    # Seahub web interface
    #
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1
    __SEAFILE_COMMENTED__ ProxyPass "/seafile" "fcgi://127.0.0.1:8000/seafile"

    ### ParaViewWeb (optional

    # Have Apache pass these requests to the ParaViewWeb launcher
    __PREVIEW_COMMENTED__ ProxyPass /paraview http://localhost:8081/paraview

    # This is the path of the mapping file
    __PREVIEW_COMMENTED__ RewriteMap session-to-port txt:__MIG_STATE__/paraview_home/launcher/proxy.txt

    # This is the rewrite condition.
    # Look for anything with a sessionId=
    # in the query part of the URL and capture the value to use below.
    __PREVIEW_COMMENTED__ RewriteCond %{QUERY_STRING} ^sessionId=(.*)$ [NC]

    # This does the rewrite using the mapping file and the sessionId
    __PREVIEW_COMMENTED__ RewriteRule ^/proxy.*$  ws://${session-to-port:%1}/ws [P]

</VirtualHost>
</IfDefine>

<IfDefine EXT_OID_FQDN>
# SSL with OpenID access based on user login against external user DB
<VirtualHost ${EXT_OID_FQDN}:__EXT_OID_PORT__>
    # General setup for the virtual host
    ServerName ${EXT_OID_FQDN}
    # Enable the next line if you want common aliasing for public address
    #__SERVERALIAS_CLAUSE__ __BASE_FQDN__
    DocumentRoot "__MIG_STATE__/user_home"
    ErrorLog __APACHE_LOG__/ssl-oid-error.log
    CustomLog __APACHE_LOG__/ssl-oid-access.log common

    # Optional per-vhost certificate setup for use with externally signed certs
    # IMPORTANT: we split CA setup to allow both client and server cert check.
    # We only override SSLCertificateChainFile *not* SSLCACertificateFile from
    # above. Thus clients can check server cert while we verify clients certs
    # against our own CA.
    __VHOSTCERTS_COMMENTED__SSLCertificateFile __MIG_CERTS__/${EXT_OID_FQDN}/server.crt
    __VHOSTCERTS_COMMENTED__SSLCertificateKeyFile __MIG_CERTS__/${EXT_OID_FQDN}/server.key
    __VHOSTCERTS_COMMENTED__SSLCertificateChainFile __MIG_CERTS__/${EXT_OID_FQDN}/server.ca.pem

    # OpenID-based access to cgi-bin (see below)
    ScriptAlias /cgi-oid/ "__MIG_CODE__/cgi-bin/"
    ScriptAlias /cgi-bin/ "__MIG_CODE__/cgi-bin/"
    ScriptAlias /cgi-sid/ "__MIG_CODE__/cgi-sid/"

    <IfModule mod_headers.c>
        # Use HSTS if enabled
        __HSTS_COMMENTED__Header always set Strict-Transport-Security "max-age=15768000"
        # OpenID 2.0's relying party verification mechanism requires this header
        Header always set X-XRDS-Location "https://__SID_FQDN__:__SID_PORT__/cgi-sid/oiddiscover.py"
        # As a precaution apply proxy limit in line with security advisory on:
        # http://www.apache.org/security/asf-httpoxy-response.txt
        RequestHeader unset Proxy early
    </IfModule>

    <IfModule mod_wsgi.c>
        WSGIScriptAlias /wsgi-bin "__MIG_CODE__/wsgi-bin/migwsgi.py"
        # Optional software repository from grid.dk (partial checkout)
        WSGIScriptAlias /software-repository "__MIG_CODE__/software-repository/swrepo.py"
    </IfModule>
    
    #   SSL Engine Switch:
    #   Enable/Disable SSL for this virtual host.
    SSLEngine on

    # SSL options that depend on which virtual host is used
    #   Client Authentication (Type):
    #   Client certificate verification type and depth.  Types are
    #   none, optional, require and optional_no_ca.  Depth is a
    #   number which specifies how deeply to verify the certificate
    #   issuer chain before deciding the certificate is not valid.
    SSLVerifyClient none

    # Transfer raw OpenID username to new EXT_OID_USERNAME env for use in
    # rewrites and htaccess
    SetEnvIf %{LU-A:REMOTE_USER} ^.*/([^/]+)$ EXT_OID_USERNAME="$1"

    ### Any special directories without openid requirement should go here...

    # Currently no such dirs except the globally configured ones at the top


    #### All other locations share basic OpenID conf and can use SSL envs

    <Directory "__MIG_BASE__/">
        # Where to store OpenID user session DB - must be read/write
        # to web server user (__USER__)
        # Use custom location since some distros do not allow r/w in
        # apache run dir causing mod auth openid to segfault :-(
        AuthOpenIDDBLocation __MIG_STATE__/openid_store/__EXT_OID_AUTH_DB__
        AuthOpenIDSecureCookie On
        # Default to 12 hours of access without re-login
        AuthOpenIDCookieLifespan 43200
        # We only use login page for user friendly OpenID error handling
        AuthOpenIDLoginPage https://__SID_FQDN__:__SID_PORT__/cgi-sid/login.py
        # Require auth by our own OpenID server and use the base URL
        # in order to have manual user ID selection
        AuthOpenIDSingleIdP __EXT_OID_PROVIDER_BASE__
        # Single-sign-on by forcing trust root and cookie path to server base
        AuthOpenIDTrustRoot https://${EXT_OID_FQDN}/
        AuthOpenIDCookiePath /
        # Pass SSL variables on
        SSLOptions +StdEnvVars
    </Directory>

    ### The rest are sub-dirs that inherit the general conf above and
    ### they can override any settings explicitly

    <Directory "__MIG_CODE__/cgi-bin">
        Options +ExecCGI
        AuthType OpenID
        require valid-user
        # Remove source address based access limitations here
        # NOTE: no entry for 2.4+ here since it disables auth
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    # WSGI interface (only visible if mod_wsgi is loaded)
    <Directory "__MIG_CODE__/wsgi-bin">
        AuthType OpenID
        require valid-user
        # Remove source address based access limitations here
        # NOTE: no entry for 2.4+ here since it disables auth
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_STATE__/user_home/">
        # Require a valid OpenID login for access to user home and all user
        # sub directories.
        AuthType OpenID
        require valid-user
        # Access to user home dirs is also further limited in .htaccess
        # files there.
        # Remove source address based access limitations here
        # NOTE: no entry for 2.4+ here since it disables auth
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_STATE__/user_home/*/">
        # Add additional auth restrictions with .htaccess file
        AllowOverride AuthConfig
    </Directory>
    <Directory "__MIG_STATE__/user_home/*/*/">
        # Do not allow or waste time on any nested htaccess files
        AllowOverride None
    </Directory>
    <LocationMatch "^/(index.html)?$">
        # Grant full access to landing page in user_home so that openid relying
        # party verification can work from index.html without an openid loop. 
        # The access restriction is there on individual user sub directories.
        # In apache-2.2 we must use Satisfy any rather than Authtype None here
        <IfVersion >= 2.4>
            AuthType None
            #Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Satisfy Any
        </IfVersion>
    </LocationMatch>
    # We allow access to cgi-sid with auth here just like for the cert case
    <Directory "__MIG_CODE__/cgi-sid">
        Options +ExecCGI
        AuthType OpenID
        require valid-user
        # Remove source address based access limitations here
        # NOTE: no entry for 2.4+ here since it disables auth
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>

    # BEGIN OPTIONAL MiG VGrid TRAC PROJECT TRACKER
    #
    # TODO: update to use OpenID email as username here?
    #
    # Use email from certificate DN for semi-automatic Trac login:
    # http://trac.edgewall.org/wiki/TracClientCertificates
    # We use email because we want it to be short and unique, but any field
    # on http://httpd.apache.org/docs/current/mod/mod_ssl.html should work.
    # Changes here requires sync with the trac_id_field MiG conf option.
    #
    # Common mappings from Apache to MiG conf:
    # SSL_CLIENT_S_DN -> distinguished_name
    # SSL_CLIENT_S_DN_Email -> email
    # SSL_CLIENT_S_DN_CN -> full_name
    # SSL_CLIENT_S_DN_O -> organization
    #<LocationMatch /[^/]+gi-bin/trac.[^/]+gi>
    #    SSLUserName SSL_CLIENT_S_DN_Email
    #</LocationMatch>
    # END OPTIONAL MiG VGrid TRAC PROJECT TRACKER

    # Rewriting
    RewriteEngine on
    # Notice: Using a high value for RewriteLogLevel will slow down your
    # Apache server dramatically! 
    # Only use a rewrite loglevel greater than (trace)2 for debugging!
    # These were replaced by the general logger in apache>=2.4
    <IfVersion >= 2.4>
        LogLevel notice rewrite:info
    </IfVersion>
    <IfVersion < 2.4>
        RewriteLog __APACHE_LOG__/ssl-oid-rewrite.log
        RewriteLogLevel 0
    </IfVersion>

    # Filter OpenID SReg noise from query string
    RewriteCond %{QUERY_STRING} ^openid.ns.sreg=http%3A%2F%2Fopenid.net%2Fextensions%2Fsreg%2F1.1$
    RewriteRule ^(.*) $1? [L,R]

    # Break rewriting chain for commonly-requested final destinations
    RewriteCond %{REQUEST_URI} ^/(favicon.ico|wsgi|cgi|images|public)
    RewriteRule ^ - [L]

    # Prevent trace and track requests from leaking information
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]

    ### VGrid access: Preserve WSGI sessions but fall back to CGI.

    ### Important security guard
    # Catch and reject attempts to execute arbitrary code with a fake vgrid
    # component, using e.g. a custom hgweb.Xgi script manually saved in
    # REALVGRID/mysub/.vgridscm/Xgi-bin/hgweb.Xgi where mysub is an ordinary
    # dir in the VGrid shared REALVGRID dir.
    # The *ScriptAliasMatch will match such requests because they look like
    # legitimate scm requests for a mysub vgrid, so we force redirection if
    # no matching mysub vgrid exists in the user-inaccessible vgrid_home dir.
    # We already prevent setting the executable bit on user home files so
    # fake cgi scripts would not work unless the user also found a way to
    # work around that limitation, but wsgi scripts need not be executable.
    # Thus, this guard is strictly required to protect against fake wsgi sub
    # vgrid components, and it will make cgi exploits harder, too.
    # We silently redirect any such bogus requests to the front page.
    RewriteCond %{REQUEST_URI} ^/([^/]+)/(vgrid_shared|private_base|public_base)/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$
    RewriteCond __MIG_STATE__/vgrid_home/%3 !-d
    RewriteRule ^/(.*) / [L,R]

    # Redirect to private file in vgrid
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgrid/(.*)/path/(.*) /wsgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=$2 [L,R]
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/path/.*
    RewriteRule ^/vgrid/(.*)/path/(.*) /cgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=$2 [L,R]
    # if the "path" is missing, go to top level:
    # (if there was one, the previous rewrite rule has transformed it)
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/$
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgrid/(.*)/$ /wsgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=index.html [L,R]
    RewriteCond %{REQUEST_URI} ^/vgrid/.*/$
    RewriteRule ^/vgrid/(.*)/$ /cgi-bin/showvgridprivatefile.py?vgrid_name=$1&path=index.html [L,R]

    # Redirect to member/owner tracker in vgrid - we need to introduce a
    # vgrid_shared to be able to discriminate between vgridtracker dir and
    # normal dirs in rewrite.
    RewriteCond %{REQUEST_URI} ^/vgridtracker
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridtracker/(.*) /cert_redirect/vgrid_shared/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridtracker
    RewriteRule ^/vgridtracker/(.*) /cert_redirect/vgrid_shared/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # Redirect to owner tracker in vgrid
    RewriteCond %{REQUEST_URI} ^/vgridownertracker
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/vgridownertracker/(.*) /cert_redirect/private_base/$1/.vgridtracker/wsgi-bin/trac.wsgi [L,R]
    RewriteCond %{REQUEST_URI} ^/vgridownertracker
    RewriteRule ^/vgridownertracker/(.*) /cert_redirect/private_base/$1/.vgridtracker/cgi-bin/trac.cgi [L,R]

    # Redirect server status requests to /SERVER_NAME/SERVERNAME.status
    RewriteCond %{REQUEST_URI} ^/server_status
    RewriteRule ^/server_status /%{SERVER_NAME}/%{SERVER_NAME}.status [NE,L]

    ######################################################################
    ######################################################################

    # Redirect user GET file with cert_redirect in request to users home
    # dir.
    # Get the DN from the certificate of the user.
    #
    # Rewrite DN slightly to match the actual file system homes. I.e.
    # replace space with underscore and slash with plus in certificate DN.
    #
    # As an example we want /cert_redirect/PATH for the user with DN: 
    # /C=DK/ST=NA/L=NA/O=NBI/OU=NA/CN=Jonas Bardino/emailAddress=bardino@nbi.ku.dk
    # to be mapped to 
    # /+C=DK+ST=NA+L=NA+O=NBI+OU=NA+CN=Jonas_Bardino+emailAddress=bardino@nbi.ku.dk/PATH
    # 
    # Access is restricted with htaccess file in user homes so nothing to
    # worry about in relation to users spoofing rewrite targets.

    # Set up some escape helpers

    RewriteMap escape int:escape
    RewriteMap unescape int:unescape

    # Careful to avoid breakage with exotic chars like percent in filenames. 
    # Fake certificate DN so that we can modify it further without PATH
    # interference. It may already be on final format but that doesn't hurt.
    # REMOTE_USER is only available in later stages so we must use 
    # LA-U:REMOTE_USER and it contains the full OpenID URL so we strip the
    # leading prefix until after the https://a.b.c/openid/id/ part.
    # We rename cert_redirect and finish with N(ext) rather than C(hain) to
    # avoid looping forever on the escape and delayed DN lookup rules. 

    RewriteCond %{REQUEST_URI} ^/cert_redirect/
    RewriteRule ^/cert_redirect/(.*) /cert_mangle/${escape:$1} [C]
    RewriteRule ^/cert_mangle/(.*) /strip_provider/%{LA-U:REMOTE_USER}/cert_mangle/$1 [NE,C]
    RewriteRule ^/strip_provider/__EXT_OID_PROVIDER_ID__/*(.+)/cert_mangle/(.*) $1/cert_mangle/$2 [NE,N]

    # Keep replacing space in DN with underscore
    
    RewriteRule ^(.*)\ (.*)/cert_mangle/(.*)$ $1_$2/cert_mangle/$3 [N]
    
    # Keep replacing slash in DN with plus
    
    RewriteRule ^(.*)/(.*)/cert_mangle/(.*)$ $1+$2/cert_mangle/$3 [N]

    # Finally remove certificate marker
    # IMPORTANT: all major browsers have trouble to some extent when accessing
    # the resulting cert_redirect data if we let the rules proceed as in the
    # cert case ([N]). This leads to subtle errors like IE and Chrome returning
    # an error instead of downloading e.g. PDF files when double clicking in
    # Files and FF not actually applying Settings -> style. Strangely enough
    # FF succeeds in the former and Chrome+IE in the latter case.
    # We explicitly SSL proxy ([P]) to work around the issues.
    SSLProxyEngine on
    # For security reasons we prevent Apache from acting like a forward proxy
    ProxyRequests Off
    # Finally remove certificate marker and unescape previously escaped path
    RewriteRule ^(.+)/cert_mangle/(.*)$ /$1/${unescape:$2} [P]
    
    ######################################################################
    ######################################################################
    
    # We need to let vgrid wiki cgi requests pass through to *ScriptAlias*
    # handlers.
    # NB: first regex group *must* match DNs only - not '.*'!
    RewriteRule ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /$1/private_base/$2/$3/$4/$5 [L,PT]
    RewriteRule ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/([^/]+-bin)/(.*)$ /$1/vgrid_shared/$2/$3/$4/$5 [L,PT]

    #######################################################################
    # IMPORTANT: Never allow users writing in these cgi-bin's in any way! #
    # It would leave a remote execution hole open for all VGrid members.  #
    #######################################################################

    # Public vgrid component access (disabled for now to avoid abuse)
    #ScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/cgi-bin/$3
    # Home directory vgrid component access - we need to avoid catching raw
    # cert_redirect URLs
    ScriptAliasMatch ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/user_home/$1/private_base/$2/$3/cgi-bin/$4
    ScriptAliasMatch ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/cgi-bin/(.*) __MIG_STATE__/user_home/$1/$2/$3/cgi-bin/$4
    <IfModule mod_wsgi.c>
        # Public vgrid component access (disabled for now to avoid abuse)
        #WSGIScriptAliasMatch ^/vgrid/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/wwwpublic/$1/$2/wsgi-bin/$3
        WSGIScriptAliasMatch ^/([^/]+)/private_base/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/user_home/$1/private_base/$2/$3/wsgi-bin/$4
        WSGIScriptAliasMatch ^/([^/]+)/vgrid_shared/(.*)/(.vgrid[^/]+)/wsgi-bin/(.*) __MIG_STATE__/user_home/$1/$2/$3/wsgi-bin/$4
    </IfModule>

    ### Seafile (optional)
    
    # NOTE: seahub exposed here as well for sign-up integration without 
    #       XSS/CSRF prevention issues

    # Seafile media files - rely on symlink to latest install
    __SEAFILE_COMMENTED__ Alias /seafmedia /home/mig/seafile/seafile-server-latest/seahub/media
    __SEAFILE_COMMENTED__ <Location /seafmedia>
    __SEAFILE_COMMENTED__     <IfVersion >= 2.4>
    __SEAFILE_COMMENTED__         Require all granted 
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__     <IfVersion < 2.4>
    __SEAFILE_COMMENTED__         Order allow,deny
    __SEAFILE_COMMENTED__         Allow from all
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__ </Location>

    # Expose seahub with method from https://github.com/haiwen/seafile/issues/1186
    # rather than the mod_fastcgi setup suggested in official docs
    # since CentOS does not include the ancient mod_fastcgi and recommends
    # mod_proxy_fcgi instead

    __SEAFILE_COMMENTED__ SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1

    #
    # Seafile file server
    #
    __SEAFILE_COMMENTED__ ProxyPass /seafhttp http://127.0.0.1:8082
    __SEAFILE_COMMENTED__ ProxyPassReverse /seafhttp http://127.0.0.1:8082

    #
    # Seahub web interface
    #
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1
    __SEAFILE_COMMENTED__ ProxyPass "/seafile" "fcgi://127.0.0.1:8000/seafile"

    ### ParaViewWeb (optional

    # Have Apache pass these requests to the ParaViewWeb launcher
    __PREVIEW_COMMENTED__ ProxyPass /paraview http://localhost:8081/paraview

    # This is the path of the mapping file
    __PREVIEW_COMMENTED__ RewriteMap session-to-port txt:__MIG_STATE__/paraview_home/launcher/proxy.txt

    # This is the rewrite condition.
    # Look for anything with a sessionId=
    # in the query part of the URL and capture the value to use below.
    __PREVIEW_COMMENTED__ RewriteCond %{QUERY_STRING} ^sessionId=(.*)$ [NC]

    # This does the rewrite using the mapping file and the sessionId
    __PREVIEW_COMMENTED__ RewriteRule ^/proxy.*$  ws://${session-to-port:%1}/ws [P]

</VirtualHost>
</IfDefine>
</IfModule>

# Configure SSL with session-id virtual host
<VirtualHost __SID_FQDN__:__SID_PORT__>
    # General setup for the virtual host
    ServerName __SID_FQDN__
    DocumentRoot "__MIG_STATE__/webserver_home"
    ErrorLog __APACHE_LOG__/ssl-sid-error.log
    CustomLog __APACHE_LOG__/ssl-sid-access.log common

    # Optional per-vhost certificate setup for use with externally signed certs
    # IMPORTANT: we split CA setup to allow both client and server cert check.
    # We only override SSLCertificateChainFile *not* SSLCACertificateFile from
    # above. Thus clients can check server cert while we verify clients certs
    # against our own CA.
    __VHOSTCERTS_COMMENTED__SSLCertificateFile __MIG_CERTS__/__SID_FQDN__/server.crt
    __VHOSTCERTS_COMMENTED__SSLCertificateKeyFile __MIG_CERTS__/__SID_FQDN__/server.key
    __VHOSTCERTS_COMMENTED__SSLCertificateChainFile __MIG_CERTS__/__SID_FQDN__/server.ca.pem

    ScriptAlias /cgi-sid/ "__MIG_CODE__/cgi-sid/"

    <IfModule mod_headers.c>
        # Use HSTS if enabled
        __HSTS_COMMENTED__Header always set Strict-Transport-Security "max-age=15768000"
        # As a precaution apply proxy limit in line with security advisory on:
        # http://www.apache.org/security/asf-httpoxy-response.txt
        RequestHeader unset Proxy early
    </IfModule>

    <IfModule mod_wsgi.c>
        WSGIScriptAlias /wsgi-bin "__MIG_CODE__/wsgi-bin/migwsgi.py"
        # Optional software repository from grid.dk (partial checkout)
        WSGIScriptAlias /software-repository "__MIG_CODE__/software-repository/swrepo.py"
    </IfModule>

    #   SSL Engine Switch:
    #   Enable/Disable SSL for this virtual host.
    SSLEngine on

    # SSL options that depend on which virtual host is used
    #   Client Authentication (Type):
    #   Client certificate verification type and depth.  Types are
    #   none, optional, require and optional_no_ca.  Depth is a
    #   number which specifies how deeply to verify the certificate
    #   issuer chain before deciding the certificate is not valid.
    SSLVerifyClient none

    ### Any special directories without auth requirement should go here...

    # Currently no such dirs except the globally configured ones at the top

    #### All other locations share basic conf and can use SSL envs

    <Directory "__MIG_BASE__/">
        # Pass SSL variables on
        SSLOptions +StdEnvVars
    </Directory>

    ### The rest are sub-dirs that inherit the general conf above and
    ### they can override any settings explicitly

    # WSGI interface (only visible if mod_wsgi is loaded)
    <Directory "__MIG_CODE__/wsgi-bin">
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    <Directory "__MIG_CODE__/cgi-sid">
        Options +ExecCGI
        # Remove source address based access limitations here
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    # SID access from resources
    Alias /sid_redirect/ "__MIG_STATE__/webserver_home/"
    <Directory "__MIG_STATE__/webserver_home/">
        # Remove source address based access limitations here
        # Access is restricted by long random hashed session IDs
        <IfVersion >= 2.4>
            Require all granted 
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Allow from all
        </IfVersion>
    </Directory>
    # Low level share link file access from e.g. external users
    # High level file management goes through cgi-sid
    # Please refer to the notes in shared.sharelinks for sharelink ID details
    AliasMatch "^/share_redirect/([a-hA-H].*)" "__MIG_STATE__/sharelink_home/read-only/$1"
    AliasMatch "^/share_redirect/([i-pI-P].*)" "__MIG_STATE__/sharelink_home/read-write/$1"
    AliasMatch "^/share_redirect/([q-xQ-X].*)" "__MIG_STATE__/sharelink_home/write-only/$1"
    <Directory "__MIG_STATE__/sharelink_home">
        # Don't allow direct access here, only in sub directories
        <IfVersion >= 2.4>
            Require all denied 
        </IfVersion>
        <IfVersion < 2.4>
            Order deny,allow
            Deny from all
        </IfVersion>
    </Directory>
    <IfModule mod_actions.c>
    <Directory "__MIG_STATE__/sharelink_home/read-only">
        # Remove source address based access limits for allowed methods
        # Access is additionally restricted by long random hashed session IDs
        <Limit GET>
            <IfVersion >= 2.4>
                Require all granted 
            </IfVersion>
            <IfVersion < 2.4>
                Order allow,deny
                Allow from all
            </IfVersion>
        </LIMIT>
        <LimitExcept GET>
            <IfVersion >= 2.4>
                Require all denied 
            </IfVersion>
            <IfVersion < 2.4>
                Order deny,allow
                Deny from all
           </IfVersion>
        </LimitExcept>
    </Directory>
    <Directory "__MIG_STATE__/sharelink_home/write-only">
        # Remove source address based access limits for allowed methods
        # Access is additionally restricted by long random hashed session IDs
        <Limit PUT SHAREPUT>
            <IfVersion >= 2.4>
                Require all granted 
            </IfVersion>
            <IfVersion < 2.4>
                Order allow,deny
                Allow from all
            </IfVersion>
        </LIMIT>
        <LimitExcept PUT SHAREPUT>
            <IfVersion >= 2.4>
                Require all denied 
            </IfVersion>
            <IfVersion < 2.4>
                Order deny,allow
                Deny from all
            </IfVersion>
        </LimitExcept>
        Script PUT /cgi-sid/put
        Script SHAREPUT /cgi-sid/put
    </Directory>
    <Directory "__MIG_STATE__/sharelink_home/read-write">
        # Remove source address based access limits for allowed methods
        # Access is additionally restricted by long random hashed session IDs
        <Limit GET PUT SHAREPUT>
            <IfVersion >= 2.4>
                Require all granted 
            </IfVersion>
            <IfVersion < 2.4>
                Order allow,deny
                Allow from all
            </IfVersion>
        </LIMIT>
        <LimitExcept GET PUT SHAREPUT>
            <IfVersion >= 2.4>
                Require all denied 
            </IfVersion>
            <IfVersion < 2.4>
                Order deny,allow
                Deny from all
            </IfVersion>
        </LimitExcept>
        Script PUT /cgi-sid/put
        Script SHAREPUT /cgi-sid/put
    </Directory>
    </IfModule>

    # Rewriting
    RewriteEngine on
    # Notice: Using a high value for RewriteLogLevel will slow down your
    # Apache server dramatically! 
    # Only use a rewrite loglevel greater than (trace)2 for debugging!
    # These were replaced by the general logger in apache>=2.4
    <IfVersion >= 2.4>
        LogLevel notice rewrite:info
    </IfVersion>
    <IfVersion < 2.4>
        RewriteLog __APACHE_LOG__/ssl-sid-rewrite.log
        RewriteLogLevel 0
    </IfVersion>

    # Break rewriting chain for commonly-requested final destinations
    RewriteCond %{REQUEST_URI} ^/(favicon.ico|wsgi|cgi|images|public)
    RewriteRule ^ - [L]

    # Prevent trace and track requests from leaking information
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F]

    # Stay on wsgi-bin if user comes from that already, otherwise use cgi-sid
    RewriteCond %{REQUEST_URI} ^/sharelink/.*$
    RewriteCond %{HTTP_REFERER} /wsgi-bin/
    RewriteRule ^/sharelink/(.*)$ /wsgi-bin/ls.py?share_id=$1 [L,R]
    RewriteCond %{REQUEST_URI} ^/sharelink/.*$
    RewriteRule ^/sharelink/(.*)$ /cgi-sid/ls.py?share_id=$1 [L,R]

    ### Seafile (optional)

    # Seafile media files - rely on symlink to latest install
    __SEAFILE_COMMENTED__ Alias /seafmedia /home/mig/seafile/seafile-server-latest/seahub/media
    __SEAFILE_COMMENTED__ <Location /seafmedia>
    __SEAFILE_COMMENTED__     <IfVersion >= 2.4>
    __SEAFILE_COMMENTED__         Require all granted 
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__     <IfVersion < 2.4>
    __SEAFILE_COMMENTED__         Order allow,deny
    __SEAFILE_COMMENTED__         Allow from all
    __SEAFILE_COMMENTED__     </IfVersion>
    __SEAFILE_COMMENTED__ </Location>

    # Expose seahub with method from https://github.com/haiwen/seafile/issues/1186
    # rather than the mod_fastcgi setup suggested in official docs
    # since CentOS does not include the ancient mod_fastcgi and recommends
    # mod_proxy_fcgi instead

    __SEAFILE_COMMENTED__ SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1

    #
    # Seafile file server
    #
    __SEAFILE_COMMENTED__ ProxyPass /seafhttp http://127.0.0.1:8082
    __SEAFILE_COMMENTED__ ProxyPassReverse /seafhttp http://127.0.0.1:8082

    #
    # Seahub web interface
    #
    __SEAFILE_COMMENTED__ SetEnvIf Request_URI . proxy-fcgi-pathinfo=1
    __SEAFILE_COMMENTED__ ProxyPass "/seafile" "fcgi://127.0.0.1:8000/seafile"

</VirtualHost>
